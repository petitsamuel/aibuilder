version: "3.9"

services:
  app:
    image: node:22-alpine
    working_dir: /app
    ports:
      - "3000:3000"
    volumes:
      - ./:/app
      - app_node_modules:/app/node_modules
    env_file:
      - .env
    environment:
      NODE_ENV: development
      SKIP_ENV_VALIDATION: "true"
      NEXT_TELEMETRY_DISABLED: "1"
      PORT: "3000"
      HOSTNAME: 0.0.0.0
      CHOKIDAR_USEPOLLING: "true"
      # Provide sane defaults; override in .env if desired
      DATABASE_URL: "${DATABASE_URL:-file:./dev.db}"
      AUTH_SECRET: "${AUTH_SECRET:-changeme-in-.env}"
      AUTH_DISCORD_ID: "${AUTH_DISCORD_ID:-}"
      AUTH_DISCORD_SECRET: "${AUTH_DISCORD_SECRET:-}"
    command: >-
      sh -c "npm install && npm run db:push && npm run dev -- --port 3000 -H 0.0.0.0"
    restart: unless-stopped

  # Optional: Prisma Studio UI (enable with profile 'studio')
  studio:
    image: node:22-alpine
    working_dir: /app
    profiles: ["studio"]
    ports:
      - "5555:5555"
    volumes:
      - ./:/app
      - app_node_modules:/app/node_modules
    env_file:
      - .env
    environment:
      NODE_ENV: development
      SKIP_ENV_VALIDATION: "true"
      DATABASE_URL: "${DATABASE_URL:-file:./dev.db}"
    command: >-
      sh -c "npm install && npx prisma studio"

  # Production-style run (enable with profile 'prod')
  app-prod:
    image: node:22-alpine
    working_dir: /app
    profiles: ["prod"]
    ports:
      - "3000:3000"
    volumes:
      - ./:/app
      - app_node_modules:/app/node_modules
    env_file:
      - .env
    environment:
      NODE_ENV: production
      SKIP_ENV_VALIDATION: "true"
      NEXT_TELEMETRY_DISABLED: "1"
      PORT: "3000"
      HOSTNAME: 0.0.0.0
      DATABASE_URL: "${DATABASE_URL:-file:./dev.db}"
      AUTH_SECRET: "${AUTH_SECRET:-changeme-in-.env}"
      AUTH_DISCORD_ID: "${AUTH_DISCORD_ID:-}"
      AUTH_DISCORD_SECRET: "${AUTH_DISCORD_SECRET:-}"
    command: >-
      sh -c "npm install && npm run db:push && npm run preview"
    restart: unless-stopped

volumes:
  app_node_modules:


